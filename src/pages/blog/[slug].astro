---
import { Image } from "astro:assets";
import BaseLayout from "../../layouts/BaseLayout.astro";
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post: CollectionEntry<"blog">) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<"blog">;
}

const { post } = Astro.props;
const { Content } = await post.render();

// Dynamic import based on post slug
let blogImage;
try {
  const imagePath = `../../assets${post.data.image}`;
  console.log('Attempting to load image:', { 
    postImage: post.data.image,
    constructedPath: imagePath 
  });
  blogImage = post.data.image ? (await import(imagePath)).default : null;
} catch (e) {
  console.error('Image import error:', e);
  blogImage = null;
}
---

<BaseLayout title={post.data.title} description={post.data.description || ""}>
  <div class="section-container">
    <div class="post-header">
      <h2>{post.data.tags.includes("notebook") ? "Notebook" : "Thought"}</h2>
      <h1>{post.data.title}</h1>
      <div class="post-meta">
        {
          post.data.startedDate &&
            `Started: ${post.data.startedDate?.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })}`
        }
        {
          post.data.startedDate && post.data.publishDate && (
            <span>&nbsp;Â·&nbsp;</span>
          )
        }
        {
          post.data.publishDate &&
            `Updated: ${post.data.publishDate?.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })}`
        }
      </div>
    </div>
    
    {
      blogImage && (
        <div class="post-image">
          <figure>
            <Image
              src={blogImage}
              alt={post.data.title}
              width={800}
              height={400}
              loading="eager"
            />
          </figure>
          <figcaption>
            {post.data.imageDescription && <p>{post.data.imageDescription}</p>}
          </figcaption>
        </div>
      )
    }
 
    <div class="blog-post-content">
      <article class="prose">
        <Content />
      </article>
    </div>
  </div>
</BaseLayout>

<style>
  .post-header {
    display: flex;
    flex-direction: column;

    h2 {
      margin-bottom: var(--spacing-base);
    }

    h1 {
      margin-bottom: var(--spacing-base);
    }
  }

  .post-image {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-base);
    margin: var(--spacing-double) 0;
    figure {
      display: flex;
      justify-content: center;
      align-items: center;
      border: 4px solid var(--color-lines);
      border-radius: 12px;
      overflow: hidden;
      filter: drop-shadow(0 0 10px var(--color-lines));

      img {
        width: 100%;
        height: auto;
      }
    }

    figcaption {
      font-size: var(--font-size-small);
    }
  }
</style>
